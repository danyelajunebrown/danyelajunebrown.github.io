{% extends "base.html" %}
{% block title %}Upload - WearAnalysis{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-6">
    <h1 class="text-3xl font-bold">Upload New Scan</h1>
    
    <form id="upload-form" class="bg-gray-800 rounded-lg p-6 space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium mb-2">Category</label>
                <select name="category" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
                    <option value="sneaker">Sneakers</option>
                    <option value="clothing">Clothing</option>
                    <option value="zipper">Zippers</option>
                    <option value="tech">Technology</option>
                    <option value="body">Body</option>
                    <option value="misc">Misc</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">Object Type</label>
                <input type="text" name="object_type" placeholder="e.g., running shoes"
                       class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">Brand</label>
                <input type="text" name="brand" placeholder="e.g., Nike"
                       class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
            </div>
            
            <div>
                <label class="block text-sm font-medium mb-2">Age (months)</label>
                <input type="number" name="age_months" min="0"
                       class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2">
            </div>
        </div>
        
        <div>
            <label class="block text-sm font-medium mb-2">Severity (1-10)</label>
            <input type="range" name="damage_severity" min="1" max="10" value="5" 
                   class="w-full" oninput="this.nextElementSibling.textContent = this.value">
            <span class="text-blue-400 font-bold">5</span>
        </div>
        
        <div>
            <label class="block text-sm font-medium mb-2">Damage Types</label>
            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center space-x-2">
                    <input type="checkbox" name="damage_types" value="wear">
                    <span>Wear</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" name="damage_types" value="stains">
                    <span>Stains</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" name="damage_types" value="tears">
                    <span>Tears</span>
                </label>
                <label class="flex items-center space-x-2">
                    <input type="checkbox" name="damage_types" value="cracks">
                    <span>Cracks</span>
                </label>
            </div>
        </div>
        
        <div>
            <label class="block text-sm font-medium mb-2">Photos</label>
            <div class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center">
                <input type="file" id="photos" multiple accept="image/*" class="hidden">
                <label for="photos" class="cursor-pointer">
                    <div class="text-4xl mb-4">ðŸ“·</div>
                    <div>Click to select photos (20-50 recommended)</div>
                </label>
                <div id="photo-preview" class="mt-4 grid grid-cols-4 gap-2"></div>
            </div>
        </div>
        
        <div>
            <label class="block text-sm font-medium mb-2">Notes</label>
            <textarea name="notes" rows="3" placeholder="Additional context"
                      class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2"></textarea>
        </div>
        
        <button type="submit" id="submit-btn"
                class="w-full px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg">
            Upload & Process
        </button>
        
        <div id="upload-progress" class="hidden">
            <div class="w-full bg-gray-700 rounded-full h-2">
                <div id="progress-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
            </div>
            <div id="progress-text" class="text-center mt-2">Uploading...</div>
        </div>
    </form>
</div>

<script>
document.getElementById('photos').addEventListener('change', function(e) {
    const preview = document.getElementById('photo-preview');
    preview.innerHTML = '';
    
    Array.from(e.target.files).slice(0, 12).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'w-full h-16 object-cover rounded';
            preview.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
});

document.getElementById('upload-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const photos = document.getElementById('photos').files;
    
    if (photos.length === 0) {
        alert('Please select photos');
        return;
    }
    
    Array.from(photos).forEach(photo => formData.append('photos', photo));
    
    const metadata = {
        category: document.querySelector('[name="category"]').value,
        object_type: document.querySelector('[name="object_type"]').value,
        brand: document.querySelector('[name="brand"]').value,
        age_months: parseInt(document.querySelector('[name="age_months"]').value) || 0,
        damage_severity: parseInt(document.querySelector('[name="damage_severity"]').value),
        damage_types: Array.from(document.querySelectorAll('[name="damage_types"]:checked')).map(cb => cb.value),
        notes: document.querySelector('[name="notes"]').value
    };
    
    formData.append('metadata', JSON.stringify(metadata));
    
    document.getElementById('upload-progress').classList.remove('hidden');
    document.getElementById('submit-btn').disabled = true;
    
    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            document.getElementById('progress-text').textContent = 'Upload complete!';
            setTimeout(() => {
                window.location.href = `/viewer/${result.session_id}`;
            }, 2000);
        } else {
            throw new Error(result.error);
        }
    } catch (error) {
        alert('Upload failed: ' + error.message);
        document.getElementById('upload-progress').classList.add('hidden');
        document.getElementById('submit-btn').disabled = false;
    }
});
</script>
{% endblock %}
