<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Test</title>
    <style>
        body {
            font-family: -apple-system, sans-serif;
            padding: 20px;
            max-width: 400px;
            margin: 0 auto;
        }
        button {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            margin: 10px 0;
            border-radius: 10px;
            border: none;
            background: #007AFF;
            color: white;
        }
        button:disabled {
            background: #ccc;
        }
        .status {
            padding: 15px;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 14px;
        }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        audio {
            width: 100%;
            margin: 10px 0;
        }
        h1 { font-size: 24px; }
        p { color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <h1>Audio Capture Test</h1>
    <p>1. Start playing music in Spotify/Apple Music<br>
       2. Tap "Request Mic" - does music stop?<br>
       3. If music keeps playing, tap "Record 5s"<br>
       4. Play back to hear if music was captured</p>

    <div id="status" class="status">Ready - start your music first!</div>

    <button id="micBtn" onclick="requestMic()">1. Request Mic Access</button>
    <button id="recordBtn" onclick="startRecording()" disabled>2. Record 5 Seconds</button>

    <div id="playbackArea"></div>

    <script>
        let audioStream = null;
        let mediaRecorder = null;
        let chunks = [];

        async function requestMic() {
            document.getElementById('status').textContent = 'Requesting mic...';
            document.getElementById('status').className = 'status';

            try {
                // Request mic with settings that preserve music quality
                audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });

                document.getElementById('status').textContent =
                    'Mic access granted! Is your music still playing? If yes, proceed to step 2.';
                document.getElementById('status').className = 'status success';
                document.getElementById('recordBtn').disabled = false;
                document.getElementById('micBtn').disabled = true;

            } catch (err) {
                document.getElementById('status').textContent = 'Mic access denied: ' + err.message;
                document.getElementById('status').className = 'status error';
            }
        }

        function startRecording() {
            if (!audioStream) return;

            chunks = [];
            document.getElementById('status').textContent = 'Recording for 5 seconds...';
            document.getElementById('status').className = 'status';
            document.getElementById('recordBtn').disabled = true;

            mediaRecorder = new MediaRecorder(audioStream);

            mediaRecorder.ondataavailable = (e) => {
                if (e.data.size > 0) chunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const url = URL.createObjectURL(blob);

                document.getElementById('playbackArea').innerHTML = `
                    <p><strong>3. Play back your recording:</strong></p>
                    <audio controls src="${url}"></audio>
                    <p>Can you hear your background music in the recording?</p>
                    <button onclick="location.reload()">Test Again</button>
                `;

                document.getElementById('status').textContent =
                    'Recording complete! Play it back below.';
                document.getElementById('status').className = 'status success';
            };

            mediaRecorder.start();

            // Stop after 5 seconds
            setTimeout(() => {
                if (mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
            }, 5000);
        }
    </script>
</body>
</html>
