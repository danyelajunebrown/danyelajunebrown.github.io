<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dance Livestream</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        h1 {
            font-size: 24px;
            color: #374151;
            margin-bottom: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 30px;
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-badge.live {
            background: #ef4444;
            color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .status-badge.ready {
            background: #10b981;
            color: white;
        }

        .status-badge.auth {
            background: #3b82f6;
            color: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .timer {
            font-size: 64px;
            font-weight: 700;
            color: #374151;
            font-variant-numeric: tabular-nums;
            margin-bottom: 30px;
        }

        .instructions {
            background: #f9fafb;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-size: 15px;
            color: #4b5563;
            line-height: 1.6;
        }

        button {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-google {
            background: white;
            color: #374151;
            border: 2px solid #e5e7eb;
        }

        .btn-google:hover {
            border-color: #667eea;
        }

        .btn-primary:active, .btn-google:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-stop {
            background: #374151;
            color: white;
        }

        .user-info {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 20px;
        }

        .settings-link {
            margin-top: 15px;
            color: #9ca3af;
            font-size: 13px;
            cursor: pointer;
        }

        .settings {
            display: none;
            margin-top: 20px;
            text-align: left;
        }

        .settings.visible {
            display: block;
        }

        .settings input {
            width: 100%;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .settings button {
            padding: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dance Livestream</h1>
        <div class="status-badge" id="statusBadge">Ready</div>

        <div class="timer" id="timer">00:00</div>

        <div class="instructions" id="instructions">
            Sign in with YouTube to enable<br>automatic livestream creation
        </div>

        <div id="authSection">
            <button id="authBtn" class="btn-google">Sign in with YouTube</button>
        </div>

        <div id="mainSection" style="display:none;">
            <div class="user-info" id="userInfo"></div>
            <button id="mainBtn" class="btn-primary">Start Camera</button>
            <button id="stopBtn" class="btn-stop" style="display:none;">Stop Streaming</button>
        </div>

        <div class="settings-link" id="settingsLink">Settings</div>
        <div class="settings" id="settings">
            <input type="text" id="relayUrl" placeholder="Relay Server URL">
            <button class="btn-primary" id="saveBtn">Save Settings</button>
            <button class="btn-google" id="signOutBtn" style="margin-top:10px;">Sign Out</button>
        </div>
    </div>

    <script>
        // Google OAuth Config
        const CLIENT_ID = '129984821928-auh8a1ssi83ob4mr74bl5n9o3p81g11u.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/youtube';
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        // Default relay
        const DEFAULT_RELAY = 'wss://dance.danyelica.fish';

        // State
        let accessToken = localStorage.getItem('yt_access_token');
        let videoStream = null;
        let streamSocket = null;
        let mediaRecorder = null;
        let isStreaming = false;
        let timerInterval = null;
        let startTime = null;
        let currentBroadcastId = null;
        let currentStreamKey = null;

        // Motion detection
        let lastMotion = Date.now();
        let isStill = false;

        // Elements
        const authBtn = document.getElementById('authBtn');
        const authSection = document.getElementById('authSection');
        const mainSection = document.getElementById('mainSection');
        const mainBtn = document.getElementById('mainBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusBadge = document.getElementById('statusBadge');
        const timer = document.getElementById('timer');
        const instructions = document.getElementById('instructions');
        const userInfo = document.getElementById('userInfo');
        const settingsLink = document.getElementById('settingsLink');
        const settings = document.getElementById('settings');
        const relayUrlInput = document.getElementById('relayUrl');
        const saveBtn = document.getElementById('saveBtn');
        const signOutBtn = document.getElementById('signOutBtn');

        // Check for OAuth callback
        function checkAuthCallback() {
            const hash = window.location.hash;
            if (hash.includes('access_token')) {
                const params = new URLSearchParams(hash.substring(1));
                accessToken = params.get('access_token');
                localStorage.setItem('yt_access_token', accessToken);
                // Clean URL
                history.replaceState(null, '', window.location.pathname);
            }
        }

        // Initialize
        async function init() {
            checkAuthCallback();
            loadSettings();

            if (accessToken) {
                // Verify token is still valid
                try {
                    const response = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet&mine=true', {
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.items && data.items.length > 0) {
                            const channel = data.items[0].snippet;
                            showMainUI(channel.title);
                            return;
                        }
                    }
                } catch (e) {
                    console.error('Token validation failed:', e);
                }
                // Token invalid, clear it
                localStorage.removeItem('yt_access_token');
                accessToken = null;
            }
            showAuthUI();
        }

        function showAuthUI() {
            authSection.style.display = 'block';
            mainSection.style.display = 'none';
            instructions.innerHTML = 'Sign in with YouTube to enable<br>automatic livestream creation';
        }

        function showMainUI(channelName) {
            authSection.style.display = 'none';
            mainSection.style.display = 'block';
            userInfo.textContent = 'Signed in as: ' + channelName;
            statusBadge.textContent = 'Ready';
            statusBadge.className = 'status-badge ready';
            instructions.innerHTML = '1. Start your music<br>2. Tap Start Camera<br>3. Set phone down to stream';
        }

        // Google OAuth
        authBtn.onclick = () => {
            const authUrl = 'https://accounts.google.com/o/oauth2/v2/auth?' +
                'client_id=' + CLIENT_ID +
                '&redirect_uri=' + encodeURIComponent(REDIRECT_URI) +
                '&response_type=token' +
                '&scope=' + encodeURIComponent(SCOPES) +
                '&include_granted_scopes=true';
            window.location.href = authUrl;
        };

        signOutBtn.onclick = () => {
            localStorage.removeItem('yt_access_token');
            accessToken = null;
            showAuthUI();
            settings.classList.remove('visible');
        };

        // Load/save settings
        function loadSettings() {
            relayUrlInput.value = localStorage.getItem('relayUrl') || DEFAULT_RELAY;
            if (!localStorage.getItem('relayUrl')) localStorage.setItem('relayUrl', DEFAULT_RELAY);
        }

        saveBtn.onclick = () => {
            localStorage.setItem('relayUrl', relayUrlInput.value);
            settings.classList.remove('visible');
            statusBadge.textContent = 'Saved!';
            setTimeout(() => statusBadge.textContent = 'Ready', 1500);
        };

        settingsLink.onclick = () => settings.classList.toggle('visible');

        // Main button
        mainBtn.onclick = async () => {
            if (!videoStream) {
                await startCamera();
            }
        };

        stopBtn.onclick = () => stopStreaming();

        // Start camera
        async function startCamera() {
            try {
                mainBtn.disabled = true;
                mainBtn.textContent = 'Starting...';

                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'user', width: 1280, height: 720 },
                    audio: false
                });

                statusBadge.textContent = 'Camera On';
                statusBadge.className = 'status-badge ready';
                instructions.innerHTML = 'Set your phone down.<br>Streaming starts when still for 3 seconds.';
                mainBtn.style.display = 'none';

                initMotion();

            } catch (err) {
                console.error(err);
                mainBtn.disabled = false;
                mainBtn.textContent = 'Try Again';
                statusBadge.textContent = 'Error: ' + err.message;
            }
        }

        // Motion detection
        function initMotion() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(response => {
                    if (response === 'granted') {
                        window.addEventListener('devicemotion', handleMotion);
                        startMotionCheck();
                    } else {
                        setTimeout(startStreaming, 3000);
                    }
                }).catch(() => setTimeout(startStreaming, 3000));
            } else if (window.DeviceMotionEvent) {
                window.addEventListener('devicemotion', handleMotion);
                startMotionCheck();
            } else {
                setTimeout(startStreaming, 3000);
            }
        }

        function handleMotion(e) {
            const a = e.accelerationIncludingGravity;
            if (!a) return;
            const movement = Math.abs(Math.sqrt(a.x*a.x + a.y*a.y + a.z*a.z) - 9.8);
            if (movement > 1.5) {
                lastMotion = Date.now();
                if (isStill && isStreaming) {
                    stopStreaming();
                    instructions.innerHTML = 'Phone picked up.<br>Set down to stream again.';
                }
                isStill = false;
            }
        }

        function startMotionCheck() {
            setInterval(() => {
                const stillTime = Date.now() - lastMotion;
                if (!isStill && stillTime > 3000) {
                    isStill = true;
                    if (!isStreaming && videoStream) {
                        startStreaming();
                    }
                }
            }, 200);
        }

        // Create YouTube broadcast via API
        async function createYouTubeBroadcast() {
            statusBadge.textContent = 'Creating stream...';

            // Create broadcast
            const broadcastResponse = await fetch('https://www.googleapis.com/youtube/v3/liveBroadcasts?part=snippet,status,contentDetails', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    snippet: {
                        title: 'Dance Session ' + new Date().toLocaleString(),
                        scheduledStartTime: new Date().toISOString()
                    },
                    status: {
                        privacyStatus: 'unlisted',
                        selfDeclaredMadeForKids: false
                    },
                    contentDetails: {
                        enableAutoStart: true,
                        enableAutoStop: true
                    }
                })
            });

            if (!broadcastResponse.ok) {
                const err = await broadcastResponse.json();
                throw new Error(err.error?.message || 'Failed to create broadcast');
            }

            const broadcast = await broadcastResponse.json();
            currentBroadcastId = broadcast.id;

            // Create stream
            const streamResponse = await fetch('https://www.googleapis.com/youtube/v3/liveStreams?part=snippet,cdn', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    snippet: {
                        title: 'Dance Stream ' + Date.now()
                    },
                    cdn: {
                        frameRate: '30fps',
                        ingestionType: 'rtmp',
                        resolution: '720p'
                    }
                })
            });

            if (!streamResponse.ok) {
                const err = await streamResponse.json();
                throw new Error(err.error?.message || 'Failed to create stream');
            }

            const stream = await streamResponse.json();
            currentStreamKey = stream.cdn.ingestionInfo.streamName;

            // Bind stream to broadcast
            const bindResponse = await fetch(`https://www.googleapis.com/youtube/v3/liveBroadcasts/bind?id=${currentBroadcastId}&part=id&streamId=${stream.id}`, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            });

            if (!bindResponse.ok) {
                const err = await bindResponse.json();
                throw new Error(err.error?.message || 'Failed to bind stream');
            }

            return currentStreamKey;
        }

        // Start streaming
        async function startStreaming() {
            const relay = localStorage.getItem('relayUrl');

            if (!relay) {
                statusBadge.textContent = 'Missing relay URL';
                settings.classList.add('visible');
                return;
            }

            try {
                // Create YouTube broadcast and get stream key
                const streamKey = await createYouTubeBroadcast();

                statusBadge.textContent = 'Connecting...';

                // Register with relay
                const http = relay.replace('wss://', 'https://').replace('ws://', 'http://');
                await fetch(`${http}/start-stream`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ streamKey, clientId: 'yt_' + Date.now() })
                });

                // Connect WebSocket
                streamSocket = new WebSocket(`${relay}?clientId=yt_${Date.now()}`);

                streamSocket.onopen = () => {
                    let mimeType = '';
                    ['video/webm;codecs=vp9', 'video/webm;codecs=vp8', 'video/webm', 'video/mp4'].forEach(type => {
                        if (!mimeType && MediaRecorder.isTypeSupported(type)) mimeType = type;
                    });

                    const options = { videoBitsPerSecond: 2500000 };
                    if (mimeType) options.mimeType = mimeType;

                    mediaRecorder = new MediaRecorder(videoStream, options);
                    mediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0 && streamSocket.readyState === WebSocket.OPEN) {
                            streamSocket.send(e.data);
                        }
                    };
                    mediaRecorder.start(1000);

                    isStreaming = true;
                    startTime = Date.now();
                    updateTimer();

                    statusBadge.textContent = 'LIVE';
                    statusBadge.className = 'status-badge live';
                    instructions.innerHTML = 'Streaming to YouTube!<br>Pick up phone to stop.';
                    stopBtn.style.display = 'block';
                };

                streamSocket.onclose = () => {
                    if (isStreaming) stopStreaming();
                };

                streamSocket.onerror = () => {
                    statusBadge.textContent = 'Connection Error';
                };

            } catch (err) {
                console.error(err);
                statusBadge.textContent = 'Error';
                instructions.innerHTML = 'Error: ' + err.message;

                // If auth error, sign out
                if (err.message.includes('401') || err.message.includes('auth')) {
                    localStorage.removeItem('yt_access_token');
                    accessToken = null;
                    showAuthUI();
                }
            }
        }

        // Stop streaming
        async function stopStreaming() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            if (streamSocket) {
                streamSocket.close();
            }

            const relay = localStorage.getItem('relayUrl');
            if (relay) {
                try {
                    const http = relay.replace('wss://', 'https://').replace('ws://', 'http://');
                    await fetch(`${http}/stop-stream`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ clientId: 'yt_' + Date.now() })
                    });
                } catch (e) {}
            }

            // Transition broadcast to complete (optional - autoStop should handle this)
            if (currentBroadcastId && accessToken) {
                try {
                    await fetch(`https://www.googleapis.com/youtube/v3/liveBroadcasts/transition?broadcastStatus=complete&id=${currentBroadcastId}&part=id`, {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + accessToken }
                    });
                } catch (e) {}
            }

            isStreaming = false;
            currentBroadcastId = null;
            currentStreamKey = null;
            clearInterval(timerInterval);
            statusBadge.textContent = 'Stopped';
            statusBadge.className = 'status-badge';
            stopBtn.style.display = 'none';
            timer.textContent = '00:00';
            mainBtn.style.display = 'block';
            mainBtn.disabled = false;
            mainBtn.textContent = 'Start Camera';
        }

        function updateTimer() {
            timerInterval = setInterval(() => {
                const s = Math.floor((Date.now() - startTime) / 1000);
                const m = Math.floor(s / 60).toString().padStart(2, '0');
                const sec = (s % 60).toString().padStart(2, '0');
                timer.textContent = `${m}:${sec}`;
            }, 1000);
        }

        // Init
        window.onload = init;
    </script>
</body>
</html>
